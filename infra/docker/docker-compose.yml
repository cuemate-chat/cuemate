services:
  # Chroma Vector DB (for RAG)
  cuemate-chroma:
    image: cuemate-chroma:${VERSION:-0.1.0}
    container_name: cuemate-chroma
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - TZ=Asia/Shanghai
    volumes:
      - chroma_data:/chroma/chroma
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # ASR Service - FunASR Real-time Speech Recognition
  cuemate-asr:
    image: cuemate-asr:${VERSION:-0.1.0}
    container_name: cuemate-asr
    ports:
      - "10095:10095"
    environment:
      - MODELSCOPE_CACHE=/app/models
      - OMP_NUM_THREADS=1
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/models:/app/models
      - /opt/cuemate/funasr-packages:/home/funasr/.local/lib/python3.11/site-packages
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # Web API (SQLite) - 端口改为3001
  web-api:
    image: cuemate-web-api:${VERSION:-0.1.0}
    build:
      context: ../..
      dockerfile: infra/docker/web-api/Dockerfile
      args:
        VERSION: ${VERSION:-0.1.0}
    container_name: cuemate-web-api
    environment:
      - NODE_ENV=production
      - WEB_API_PORT=3001
      - WEB_API_HOST=0.0.0.0
      - SQLITE_PATH=/opt/cuemate/data/sqlite/cuemate.db
      - JWT_SECRET=${JWT_SECRET:-dev-secret}
      - RAG_SERVICE_URL=http://rag-service:3003
      - LLM_ROUTER_URL=http://llm-router:3002
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/data:/opt/cuemate/data
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /opt/cuemate/pdf:/opt/cuemate/pdf
      - /opt/cuemate/images:/opt/cuemate/images
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - "3001:3001"
    networks:
      - cuemate-network
    restart: unless-stopped

  # LLM Router Service
  llm-router:
    image: cuemate-llm-router:${VERSION:-0.1.0}
    build:
      context: ../..
      dockerfile: infra/docker/llm-router/Dockerfile
      args:
        VERSION: ${VERSION:-0.1.0}
    container_name: cuemate-llm-router
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - LLM_PORT=3002
      - LLM_HOST=0.0.0.0
      - PRIMARY_LLM_PROVIDER=openai
      - ROUTING_STRATEGY=primary-fallback
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # RAG Service
  rag-service:
    image: cuemate-rag-service:${VERSION:-0.1.0}
    build:
      context: ../..
      dockerfile: infra/docker/rag-service/Dockerfile
      args:
        VERSION: ${VERSION:-0.1.0}
    container_name: cuemate-rag-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - RAG_PORT=3003
      - RAG_HOST=0.0.0.0
      - VECTOR_STORE_TYPE=chroma
      - EMBEDDINGS_PROVIDER=mock
      - CHROMA_PATH=http://cuemate-chroma:8000
      - TZ=Asia/Shanghai
    volumes:
      - chroma_data:/opt/cuemate/chroma_data
      - /opt/cuemate/documents:/opt/cuemate/documents
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    depends_on:
      - cuemate-chroma
    restart: unless-stopped

  # Web 前端（静态站 - Nginx）
  web:
    image: cuemate-web:${VERSION:-0.1.0}
    build:
      context: ../..
      dockerfile: infra/docker/web/Dockerfile
      args:
        VERSION: ${VERSION:-0.1.0}
        WEB_API_BASE: ${WEB_API_BASE:-http://localhost:3001}
    container_name: cuemate-web
    ports:
      - "80:80"
    environment:
      - VITE_WEB_API_BASE=${WEB_API_BASE:-http://cuemate-web-api:3001}
      - VITE_RAG_SERVICE_URL=http://cuemate-rag-service:3003
      - VITE_LLM_ROUTER_URL=http://cuemate-llm-router:3002
    volumes:
      - /opt/cuemate/images:/opt/cuemate/images
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    depends_on:
      - web-api
    networks:
      - cuemate-network
    restart: unless-stopped

networks:
  cuemate-network:
    driver: bridge

volumes:
  chroma_data:
