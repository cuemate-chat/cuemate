# CueMate 桌面客户端运行指南

## 项目结构
这是一个从 Tauri 迁移到 Electron 的桌面应用，具有以下窗口系统：
- **control-bar** - 浮动控制条（作为主焦点窗口）
- **close-button** - 关闭按钮窗口（focusable: false）
- **main-content** - 主内容窗口（加载 localhost:80 的 Docker web 应用，focusable: false）

### 🎯 焦点管理架构（已优化）
- **control-bar** 作为主焦点窗口，可以获得和保持系统焦点
- 其他窗口设置为 `focusable: false`，实现类似页面的悬浮交互效果
- 相比 Tauri，去掉了复杂的隐形焦点锚点窗口，架构更简洁

## 正确的运行方式

### 开发模式
```bash
cd apps/desktop-client

# 方法1: 分别启动（推荐，便于调试）
# 终端1: 启动前端开发服务器
pnpm dev

# 终端2: 启动 Electron 应用（等待前端服务器启动后）
pnpm electron:dev

# 方法2: 一键启动（需要修复 electron:dev 脚本以包含开发服务器）
# TODO: 修复 electron:dev 脚本使其自动启动开发服务器
```

**重要：必须在 `apps/desktop-client` 目录下运行，不要在项目根目录运行！**

### 生产模式
```bash
cd apps/desktop-client
pnpm build
pnpm electron
```

## 命令说明

- `pnpm electron:dev` - 开发模式启动，包含类型检查和主进程构建
- `pnpm build:main` - 只构建主进程
- `pnpm build:renderer` - 只构建渲染进程
- `pnpm build` - 完整构建
- `pnpm electron` - 启动已构建的应用

## 常见错误

❌ **错误做法**：
```bash
# 在根目录运行
pnpm dev
# 或直接运行 electron
npx electron dist/main/index.js
```

✅ **正确做法**：
```bash
# 必须在 apps/desktop-client 目录下
cd apps/desktop-client
pnpm electron:dev
```

## 窗口说明

### main-content 窗口
- **加载内容**: `http://localhost:80`（您的 Docker web 应用）
- **快捷键**: `⌘+Shift+C` 切换显示
- **说明**: 直接显示外部 web 应用，不需要自己的 React 组件

### control-bar 和 close-button 窗口
- **加载内容**: React 组件（开发时从 localhost:3000 加载）
- **快捷键**: `⌘+\` 切换浮动窗口显示

## 全局快捷键

应用启动后，可以使用以下全局快捷键：

- `⌘+\` (Cmd+反斜杠) - 切换浮动控制条显示
- `⌘+Shift+C` - 切换主内容窗口显示/隐藏
- `⌘+Alt+Q` - 隐藏所有浮动窗口
- `⌘+Alt+S` - 显示所有浮动窗口  
- `⌘+Shift+H` - 隐藏所有窗口

## 启动成功标志

当您看到以下输出时，表示应用启动成功：
```
✅ control-bar 控制条窗口已创建（作为主焦点窗口）
✅ close-button 关闭按钮窗口已创建
✅ main-content 主内容窗口已创建
📄 main-content 页面加载完成
✅ 窗口管理器初始化完成
```

**🎯 新焦点管理的优势：**
- 不再有 "main-focus 窗口" 相关的消息
- control-bar 直接作为主焦点窗口，更自然的交互
- 减少了窗口创建步骤，启动更快

## 端口配置说明

### 项目使用的端口：
- **端口 80**: Docker 后端 web 应用（main-content 窗口加载）
- **端口 3000**: Electron 前端开发服务器（control-bar 和 close-button 窗口）  
- **端口 3001**: 后端 API 服务

### 常见端口冲突问题：

❌ **如果看到 "Port 3000 is in use, trying another one..."**：
- 说明 3000 端口被占用，Vite 会自动切换到其他端口（如 3001, 3002 等）
- 但 Electron 窗口配置期望从 localhost:3000 加载，会导致加载失败

✅ **解决方法**：
```bash
# 查看占用 3000 端口的进程
lsof -ti:3000

# 杀掉占用进程（谨慎操作）
kill <进程ID>

# 重新启动开发服务器
pnpm dev
```

## 项目依赖

**重要**：确保您的 Docker web 应用在 `localhost:80` 运行，main-content 窗口会加载该地址的内容。

如果 localhost:80 无法访问，main-content 窗口将显示空白或错误页面。