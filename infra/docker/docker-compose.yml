services:
  # Chroma Vector DB (for RAG)
  chroma:
    image: ghcr.io/chroma-core/chroma:0.5.4
    container_name: cuemate-chroma
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - cuemate-network
    restart: unless-stopped

  # ASR Gateway Service
  asr-gateway:
    build:
      context: ../..
      dockerfile: infra/docker/asr-gateway/Dockerfile
    container_name: cuemate-asr-gateway
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - ASR_PORT=3001
      - ASR_HOST=0.0.0.0
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - PRIMARY_ASR_PROVIDER=deepgram
      - FALLBACK_ASR_PROVIDER=whisper
    volumes:
      - ../../services/asr-gateway/models:/app/models
      - ../../data/logs:/opt/cuemate/log
    networks:
      - cuemate-network
    restart: unless-stopped

  # LLM Router Service
  llm-router:
    build:
      context: ../..
      dockerfile: infra/docker/llm-router/Dockerfile
    container_name: cuemate-llm-router
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - LLM_PORT=3002
      - LLM_HOST=0.0.0.0
      - PRIMARY_LLM_PROVIDER=openai
      - ROUTING_STRATEGY=primary-fallback
    volumes:
      - ../../data/logs:/opt/cuemate/log
    networks:
      - cuemate-network
    restart: unless-stopped

  # RAG Service
  rag-service:
    build:
      context: ../..
      dockerfile: infra/docker/rag-service/Dockerfile
    container_name: cuemate-rag-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - RAG_PORT=3003
      - RAG_HOST=0.0.0.0
      - VECTOR_STORE_TYPE=chroma
      - EMBEDDINGS_PROVIDER=mock
      - CHROMA_PATH=http://chroma:8000
    volumes:
      - chroma_data:/app/chroma_data
      - ../../services/rag-service/documents:/app/documents
      - ../../data/logs:/opt/cuemate/log
    networks:
      - cuemate-network
    depends_on:
      - chroma
    restart: unless-stopped

  # Web API (SQLite)
  web-api:
    build:
      context: ../..
      dockerfile: infra/docker/web-api/Dockerfile
    container_name: cuemate-web-api
    environment:
      - NODE_ENV=production
      - WEB_API_PORT=3004
      - WEB_API_HOST=0.0.0.0
      - SQLITE_PATH=/opt/cuemate/data/cuemate.db
      - JWT_SECRET=${JWT_SECRET:-dev-secret}
      - RAG_SERVICE_URL=http://rag-service:3003
      - LLM_ROUTER_URL=http://llm-router:3002
    volumes:
      - ../../data/sqlite:/opt/cuemate/data
      - ../../data/logs:/opt/cuemate/log
    ports:
      - "3004:3004"
    networks:
      - cuemate-network
    restart: unless-stopped

  # Web 前端（静态站 - Nginx）
  web:
    build:
      context: ../..
      dockerfile: infra/docker/web/Dockerfile
      args:
        WEB_API_BASE: ${WEB_API_BASE:-http://web-api:3004}
    container_name: cuemate-web
    ports:
      - "80:80"
    environment:
      - VITE_WEB_API_BASE=${WEB_API_BASE:-http://web-api:3004}
      - VITE_RAG_SERVICE_URL=http://rag-service:3003
      - VITE_LLM_ROUTER_URL=http://llm-router:3002
    depends_on:
      - web-api
    networks:
      - cuemate-network
    restart: unless-stopped

networks:
  cuemate-network:
    driver: bridge

volumes:
  chroma_data:
