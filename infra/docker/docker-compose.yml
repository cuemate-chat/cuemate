services:
  # Chroma Vector DB (for RAG)
  cuemate-chroma:
    image: ${REGISTRY:-registry.cn-beijing.aliyuncs.com/cuemate}/cuemate-chroma:${VERSION}
    container_name: cuemate-chroma
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - TZ=Asia/Shanghai
    volumes:
      - chroma_data:/chroma/chroma
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # ASR Service - FunASR Real-time Speech Recognition
  cuemate-asr:
    image: ${REGISTRY:-registry.cn-beijing.aliyuncs.com/cuemate}/cuemate-asr:${VERSION}
    container_name: cuemate-asr
    ports:
      - "10095:10095"
    privileged: true
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ../../data/funasr-runtime-resources/models:/workspace/models
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped
    command: [
      "bash", "-c",
      "cd /workspace/FunASR/runtime/websocket/build/bin && ./funasr-wss-server-2pass --download-model-dir /workspace/models --model-dir damo/speech_paraformer-large-vad-punc_asr_nat-zh-cn-16k-common-vocab8404-onnx --online-model-dir damo/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-online-onnx --vad-dir damo/speech_fsmn_vad_zh-cn-16k-common-onnx --punc-dir damo/punc_ct-transformer_zh-cn-common-vad_realtime-vocab272727-onnx --itn-dir thuduj12/fst_itn_zh --lm-dir damo/speech_ngram_lm_zh-cn-ai-wesp-fst --decoder-thread-num 4 --model-thread-num 1 --io-thread-num 2 --port 10095 --certfile \"\""
    ]

  # Web API (SQLite) - 端口3001
  web-api:
    image: ${REGISTRY:-registry.cn-beijing.aliyuncs.com/cuemate}/cuemate-web-api:${VERSION}
    build:
      context: ../..
      dockerfile: infra/docker/web-api/Dockerfile
      args:
        VERSION: ${VERSION:-v0.1.0}
    container_name: cuemate-web-api
    environment:
      - NODE_ENV=production
      - WEB_API_PORT=3001
      - WEB_API_HOST=0.0.0.0
      - SQLITE_PATH=/opt/cuemate/data/sqlite/cuemate.db
      - JWT_SECRET=${JWT_SECRET:-dev-secret}
      - RAG_SERVICE_URL=http://rag-service:3003
      - LLM_ROUTER_URL=http://llm-router:3002
      - CUEMATE_LOG_DIR=/opt/cuemate/logs
      - TZ=Asia/Shanghai
    volumes:
      - ../../data/sqlite:/opt/cuemate/data/sqlite
      - ../../data/logs:/opt/cuemate/logs
      - ../../data/pdf:/opt/cuemate/pdf
      - ../../data/images:/opt/cuemate/images
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - "3001:3001"
    networks:
      - cuemate-network
    restart: unless-stopped

  # LLM Router Service
  llm-router:
    image: ${REGISTRY:-registry.cn-beijing.aliyuncs.com/cuemate}/cuemate-llm-router:${VERSION}
    build:
      context: ../..
      dockerfile: infra/docker/llm-router/Dockerfile
      args:
        VERSION: ${VERSION:-v0.1.0}
    container_name: cuemate-llm-router
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - LLM_PORT=3002
      - LLM_HOST=0.0.0.0
      - PRIMARY_LLM_PROVIDER=openai
      - ROUTING_STRATEGY=primary-fallback
      - CUEMATE_LOG_DIR=/opt/cuemate/logs
      - TZ=Asia/Shanghai
    volumes:
      - ../../data/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # RAG Service
  rag-service:
    image: ${REGISTRY:-registry.cn-beijing.aliyuncs.com/cuemate}/cuemate-rag-service:${VERSION}
    build:
      context: ../..
      dockerfile: infra/docker/rag-service/Dockerfile
      args:
        VERSION: ${VERSION:-v0.1.0}
    container_name: cuemate-rag-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - RAG_PORT=3003
      - RAG_HOST=0.0.0.0
      - VECTOR_STORE_TYPE=chroma
      - CHROMA_PATH=http://cuemate-chroma:8000
      - CUEMATE_LOG_DIR=/opt/cuemate/logs
      - TZ=Asia/Shanghai
    volumes:
      - chroma_data:/opt/cuemate/chroma_data
      - ../../data/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    depends_on:
      - cuemate-chroma
    restart: unless-stopped

  # Web 前端（静态站 - Nginx）
  web:
    image: ${REGISTRY:-registry.cn-beijing.aliyuncs.com/cuemate}/cuemate-web:${VERSION}
    build:
      context: ../..
      dockerfile: infra/docker/web/Dockerfile
      args:
        VERSION: ${VERSION:-v0.1.0}
        WEB_API_BASE: ${WEB_API_BASE:-http://localhost:3001}
    container_name: cuemate-web
    ports:
      - "80:80"
    environment:
      - VITE_WEB_API_BASE=${WEB_API_BASE:-http://cuemate-web-api:3001}
      - VITE_RAG_SERVICE_URL=http://cuemate-rag-service:3003
      - VITE_LLM_ROUTER_URL=http://cuemate-llm-router:3002
    volumes:
      - ../../data/images:/opt/cuemate/images
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    depends_on:
      - web-api
    networks:
      - cuemate-network
    restart: unless-stopped

networks:
  cuemate-network:
    driver: bridge

volumes:
  chroma_data:
