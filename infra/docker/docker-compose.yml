services:
  # Chroma Vector DB (for RAG)
  chroma:
    image: ghcr.io/chroma-core/chroma:0.5.4
    container_name: cuemate-chroma
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      - TZ=Asia/Shanghai
    volumes:
      - chroma_data:/chroma/chroma
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # ASR User - User Speech Recognition
  asr-user:
    image: cuemate-asr-user:${VERSION:-0.1.0}
    container_name: cuemate-asr-user
    ports:
      - "8001:8000"
    command: ["--model", "base", "--backend", "simulstreaming", "--lan", "zh", "--port", "8000", "--no-vac", "--no-vad"]
    environment:
      - PYTORCH_DISABLE_NET_ACCESS=1
      - ASR_SERVICE_TYPE=user
      - CUEMATE_LOG_DIR=/opt/cuemate/logs
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # ASR Interviewer - Interviewer Speech Recognition  
  asr-interviewer:
    image: cuemate-asr-interviewer:${VERSION:-0.1.0}
    container_name: cuemate-asr-interviewer
    ports:
      - "8002:8000"
    command: ["--model", "base", "--backend", "simulstreaming", "--lan", "zh", "--port", "8000", "--no-vac", "--no-vad"]
    environment:
      - PYTORCH_DISABLE_NET_ACCESS=1
      - ASR_SERVICE_TYPE=interviewer
      - CUEMATE_LOG_DIR=/opt/cuemate/logs
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # Web API (SQLite) - 端口改为3001
  web-api:
    build:
      context: ../..
      dockerfile: infra/docker/web-api/Dockerfile
      tags:
        - cuemate-web-api:${VERSION:-0.1.0}
    container_name: cuemate-web-api
    environment:
      - NODE_ENV=production
      - WEB_API_PORT=3001
      - WEB_API_HOST=0.0.0.0
      - SQLITE_PATH=/opt/cuemate/data/sqlite/cuemate.db
      - JWT_SECRET=${JWT_SECRET:-dev-secret}
      - RAG_SERVICE_URL=http://rag-service:3003
      - LLM_ROUTER_URL=http://llm-router:3002
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/data:/opt/cuemate/data
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /opt/cuemate/pdf:/opt/cuemate/pdf
      - /opt/cuemate/images:/opt/cuemate/images
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - "3001:3001"
    networks:
      - cuemate-network
    restart: unless-stopped

  # LLM Router Service
  llm-router:
    build:
      context: ../..
      dockerfile: infra/docker/llm-router/Dockerfile
      tags:
        - cuemate-llm-router:${VERSION:-0.1.0}
    container_name: cuemate-llm-router
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - LLM_PORT=3002
      - LLM_HOST=0.0.0.0
      - PRIMARY_LLM_PROVIDER=openai
      - ROUTING_STRATEGY=primary-fallback
      - TZ=Asia/Shanghai
    volumes:
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    restart: unless-stopped

  # RAG Service
  rag-service:
    build:
      context: ../..
      dockerfile: infra/docker/rag-service/Dockerfile
      tags:
        - cuemate-rag-service:${VERSION:-0.1.0}
    container_name: cuemate-rag-service
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - RAG_PORT=3003
      - RAG_HOST=0.0.0.0
      - VECTOR_STORE_TYPE=chroma
      - EMBEDDINGS_PROVIDER=mock
      - CHROMA_PATH=http://chroma:8000
      - TZ=Asia/Shanghai
    volumes:
      - chroma_data:/opt/cuemate/chroma_data
      - /opt/cuemate/documents:/opt/cuemate/documents
      - /opt/cuemate/logs:/opt/cuemate/logs
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - cuemate-network
    depends_on:
      - chroma
    restart: unless-stopped

  # Web 前端（静态站 - Nginx）
  web:
    build:
      context: ../..
      dockerfile: infra/docker/web/Dockerfile
      args:
        WEB_API_BASE: ${WEB_API_BASE:-http://localhost:3001}
      tags:
        - cuemate-web:${VERSION:-0.1.0}
    container_name: cuemate-web
    ports:
      - "80:80"
    environment:
      - VITE_WEB_API_BASE=${WEB_API_BASE:-http://cuemate-web-api:3001}
      - VITE_RAG_SERVICE_URL=http://cuemate-rag-service:3003
      - VITE_LLM_ROUTER_URL=http://cuemate-llm-router:3002
    volumes:
      - /opt/cuemate/images:/opt/cuemate/images
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    depends_on:
      - web-api
    networks:
      - cuemate-network
    restart: unless-stopped

networks:
  cuemate-network:
    driver: bridge

volumes:
  chroma_data:
